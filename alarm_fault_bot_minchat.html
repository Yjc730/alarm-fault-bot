<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Alarm-Fault 簡易對話框</title>
  <style>
    :root { --bg:#0f1115; --panel:#161a22; --line:#252b36; --text:#e6e6e6; --muted:#a4afc4; --accent:#2e6be6; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 16px; }
    .title { font-weight: 800; font-size: 18px; }
    .desc { color: var(--muted); font-size: 13px; margin-top: 4px; }
    .box { margin-top: 12px; border:1px solid var(--line); border-radius: 16px; background: var(--panel); overflow: hidden; }
    .msgs { height: 60vh; overflow:auto; padding: 12px; }
    .msg { margin: 8px 0; display:flex; gap:8px; align-items:flex-start; }
    .msg.me { justify-content: flex-end; }
    .bubble { padding: 10px 12px; background:#11151e; border:1px solid var(--line); border-radius: 12px; max-width: 85%; white-space: pre-wrap; line-height: 1.6; }
    .msg.me .bubble { background: var(--accent); border-color: var(--accent); color: white; }
    .inputbar { display:flex; gap:8px; padding: 10px; border-top:1px solid var(--line); background: #121620; }
    .inputbar input { flex:1; padding: 12px; border-radius: 10px; border:1px solid var(--line); background:#0d1119; color:var(--text); }
    .inputbar button { padding: 12px 16px; border-radius: 10px; border:1px solid var(--accent); background: var(--accent); color:white; cursor:pointer; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .kv { margin-top:6px; font-size: 13px; color:#c8d1e6; }
    .kv b { color:#9fb0d9; }
    .tag { display:inline-block; padding:1px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#b9c4db; margin-right:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Alarm-Fault 簡易對話框（純前端、零幻覺）</div>
    <div class="desc">輸入 ID（如 7100）或關鍵字；只用本地 <code>alarm_fault_data.json</code> 查詢，並給中文解釋。</div>
    <div class="box">
      <div id="msgs" class="msgs"></div>
      <div class="inputbar">
        <input id="q" type="text" placeholder="輸入 ID 或關鍵字… 例如：7100 / overheat / antenna"/>
        <button id="send">送出</button>
      </div>
    </div>
    <div id="hint" class="hint">正在載入資料…</div>
  </div>

  <script>
    const msgs = document.getElementById('msgs');
    const q = document.getElementById('q');
    const send = document.getElementById('send');
    const hint = document.getElementById('hint');
    let DATA = [];

    function add(text, me=false) {
      const row = document.createElement('div');
      row.className = 'msg' + (me ? ' me' : '');
      const b = document.createElement('div');
      b.className = 'bubble';
      if (typeof text === 'string') b.textContent = text; else b.appendChild(text);
      row.appendChild(b);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function sanitize(s){ return (s ?? '').toString(); }

    const GLOSSARY = [
      ["alarm","告警"],["fault","故障"],["warning","警告"],["critical","嚴重"],["major","重大"],["minor","次要"],
      ["cleared","已清除"],["clear","清除"],["active","啟動"],["inactive","未啟動"],
      ["power","電源"],["voltage","電壓"],["current","電流"],["overvoltage","過電壓"],["undervoltage","欠壓"],
      ["overcurrent","過電流"],["short circuit","短路"],["battery","電池"],["rectifier","整流器"],
      ["temperature","溫度"],["overheat","過熱"],["fan","風扇"],["cooling","散熱"],
      ["antenna","天線"],["feeder","饋線"],["vswr","駐波比"],["rf","射頻"],["transmitter","發射端"],["receiver","接收端"],
      ["uplink","上行"],["downlink","下行"],["baseband","基頻"],["bb","基頻"],["cabinet","機櫃"],
      ["synchronization","同步"],["gps","GPS"],["clock","時鐘"],["pll","鎖相迴路"],
      ["module","模組"],["board","板卡"],["unit","單元"],["port","埠"],["link down","鏈路中斷"],["link","鏈路"],
      ["software","軟體"],["firmware","韌體"],["hardware","硬體"],["configuration","設定"],["timeout","逾時"],
      ["restart","重啟"],["reboot","重新啟動"],["failure","失效"],["degraded","效能降低"],["maintenance","維護"],
      ["threshold","門檻"],["interference","干擾"],["jam","阻塞"],["congestion","壅塞"],
      ["site","站點"],["node","節點"],["sector","扇區"],["cell","小區"]
    ];
    function zhGlossary(t){
      let out = sanitize(t);
      GLOSSARY.forEach(([en, zh]) => {
        const re = new RegExp(en.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        out = out.replace(re, zh);
      });
      return out;
    }

    function toChinese(rec){
      const parts = [];
      const alarm = sanitize(rec.alarm_name);
      const fault = sanitize(rec.fault_name);
      const meaning = sanitize(rec.meaning);
      const cause = sanitize(rec.probable_cause);
      const clearing = sanitize(rec.clearing);
      if (alarm || fault) parts.push(`告警/故障：${zhGlossary(alarm)||"—"} / ${zhGlossary(fault)||"—"}`);
      if (meaning) parts.push(`現象：${zhGlossary(meaning)}`);
      if (cause) parts.push(`可能原因：${zhGlossary(cause)}`);
      if (clearing) parts.push(`清除方式：${zhGlossary(clearing)}`);
      return parts.join('\n');
    }

    function render(rec){
      const box = document.createElement('div');
      const meta = document.createElement('div');
      meta.innerHTML = `<span class="tag">ID: ${sanitize(rec.id)}</span><span class="tag">Severity: ${sanitize(rec.severity)}</span><span class="tag">Type: ${sanitize(rec.event_type)}</span>`;
      const kv = document.createElement('div');
      kv.className = 'kv';
      kv.innerHTML = [
        rec.alarm_name ? `<div><b>Alarm Name：</b>${sanitize(rec.alarm_name)}</div>` : '',
        rec.fault_name ? `<div><b>Fault Name：</b>${sanitize(rec.fault_name)}</div>` : '',
        rec.meaning ? `<div><b>Meaning：</b>${sanitize(rec.meaning)}</div>` : '',
        rec.probable_cause ? `<div><b>Probable Cause：</b>${sanitize(rec.probable_cause)}</div>` : '',
        rec.clearing ? `<div><b>Clearing：</b>${sanitize(rec.clearing)}</div>` : '',
        rec.ttl ? `<div><b>Time To Live：</b>${sanitize(rec.ttl)}</div>` : '',
        rec.product ? `<div><b>Used In Product：</b>${sanitize(rec.product)}</div>` : '',
      ].join('');
      const zh = document.createElement('div');
      zh.className = 'kv';
      zh.style.marginTop = '8px';
      zh.style.whiteSpace = 'pre-wrap';
      zh.textContent = toChinese(rec);
      box.appendChild(meta);
      box.appendChild(kv);
      box.appendChild(zh);
      return box;
    }

    function score(rec, q){
      const s = q.toLowerCase().trim();
      let sc = 0;
      const id = sanitize(rec.id).toLowerCase();
      const alarm = sanitize(rec.alarm_name).toLowerCase();
      const fault = sanitize(rec.fault_name).toLowerCase();
      const meaning = sanitize(rec.meaning).toLowerCase();
      if (s && id === s) sc += 100;
      if (s && id.includes(s)) sc += 60;
      if (s && alarm.includes(s)) sc += 30;
      if (s && fault.includes(s)) sc += 30;
      if (s && meaning.includes(s)) sc += 20;
      return sc;
    }

    function find(q){
      const isCode = /^\d[\d\-\.]*$/.test(q.trim());
      let arr = DATA.map((r,i)=>({i,score:score(r,q)})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score);
      if (isCode){
        const idx = DATA.findIndex(r => sanitize(r.id).toLowerCase() === q.trim().toLowerCase());
        const hit = arr.find(x=>x.i===idx);
        if (hit){ hit.score += 1000; arr.sort((a,b)=>b.score-a.score); }
      }
      return arr.slice(0, isCode?1:5).map(x=>DATA[x.i]);
    }

    function handle(text){
      const res = find(text);
      if (!res.length){ add('沒有符合的資料。請改用更精確的 ID 或關鍵字。'); return; }
      if (res.length === 1){ add(render(res[0])); }
      else {
        const group = document.createElement('div');
        res.forEach((r,idx)=>{
          const head = document.createElement('div');
          head.className='hint';
          head.textContent = '第 ' + (idx+1) + ' 筆';
          group.appendChild(head);
          group.appendChild(render(r));
        });
        add(group);
      }
    }

    send.addEventListener('click', ()=>{
      const text = q.value;
      if (!text.trim()) return;
      add(text, true);
      handle(text);
      q.value=''; q.focus();
    });
    q.addEventListener('keydown', (e)=>{ if (e.key==='Enter') send.click(); });

    (async function init(){
      try{
        const resp = await fetch('alarm_fault_data.json');
        DATA = await resp.json();
        hint.textContent = '載入完成，共 ' + DATA.length + ' 筆。';
      }catch(e){
        hint.textContent = '載入失敗：請確認 alarm_fault_data.json 與本頁在同一資料夾。';
      }
    })();
  </script>
</body>
</html>
